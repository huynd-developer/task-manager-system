<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${product.name}">Chi tiết sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .quantity-input {
            width: 70px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .login-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="container main-content mt-5 pt-4">

    <div class="container mt-4">
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row" th:if="${product}">
            <div class="col-md-6">
                <img th:src="${product.imageUrl ?: '/images/default-product.jpg'}"
                     th:alt="${product.name}"
                     class="img-fluid rounded"
                     style="max-height: 400px; object-fit: cover;"
                     onerror="this.src='/images/default-product.jpg'">
            </div>
            <div class="col-md-6">
                <h2 th:text="${product.name}">Tên sản phẩm</h2>
                <p class="text-muted" th:text="${product.description}">Mô tả sản phẩm</p>

                <h4 class="text-primary"
                    th:text="'₫' + ${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">
                    Giá sản phẩm
                </h4>

                <div class="mb-3">
                    <span th:if="${product.stockQuantity > 0}"
                          class="badge bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>
                        Còn <span th:text="${product.stockQuantity}"></span> sản phẩm
                    </span>
                    <span th:if="${product.stockQuantity <= 0}"
                          class="badge bg-danger fs-6">
                        <i class="fas fa-times-circle me-1"></i>
                        Hết hàng
                    </span>
                </div>

                <div sec:authorize="isAuthenticated()">
                    <div id="vue-add-to-cart"></div>
                </div>

                <div sec:authorize="!isAuthenticated()" class="login-message">
                    <div class="text-center">
                        <i class="fas fa-lock fa-2x text-warning mb-2"></i>
                        <h5 class="text-warning">Vui lòng đăng nhập để mua hàng</h5>
                        <p class="text-muted small">
                            Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng
                        </p>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a th:href="@{/login}" class="btn btn-warning">
                                <i class="fas fa-sign-in-alt me-1"></i> Đăng nhập
                            </a>
                            <a th:href="@{/register}" class="btn btn-outline-primary">
                                <i class="fas fa-user-plus me-1"></i> Đăng ký
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:unless="${product}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Sản phẩm không tồn tại hoặc đã bị xóa.
        </div>

        <div class="mt-4">
            <a th:href="@{/products}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Quay lại danh sách sản phẩm
            </a>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:if="${#authorization.expression('isAuthenticated()')}">
    const {createApp} = Vue;

    const AddToCartComponent = {
        template: `
          <div class="vue-add-to-cart-container">
            <div class="mb-3">
              <label class="form-label fw-bold">
                <i class="fas fa-cart-plus me-2"></i>Số lượng:
              </label>
              <div class="quantity-controls">
                <button @click="decrement"
                        :disabled="quantity <= 1 || loading"
                        class="quantity-btn">
                  <i class="fas fa-minus"></i>
                </button>
                <input type="number"
                       v-model.number="quantity"
                       :max="stockQuantity"
                       min="1"
                       :disabled="loading || stockQuantity <= 0"
                       class="form-control quantity-input">
                <button @click="increment"
                        :disabled="quantity >= stockQuantity || loading"
                        class="quantity-btn">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <small class="text-muted">
                <i class="fas fa-box me-1"></i>
                Tối đa: <span class="fw-bold">{{ stockQuantity }}</span> sản phẩm
              </small>
            </div>

            <button @click="addToCart"
                    :disabled="loading || stockQuantity <= 0"
                    class="btn btn-primary btn-lg w-100 py-3">
                <span v-if="loading">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Đang xử lý...
                </span>
              <span v-else>
                    <i class="fas fa-cart-plus me-2"></i> Thêm vào giỏ hàng
                </span>
            </button>

            <div v-if="message" class="alert mt-3 alert-dismissible fade show" :class="messageClass">
              <span v-html="message"></span>
              <button type="button" class="btn-close" @click="clearMessage"></button>
            </div>

            <div v-if="addedToCart" class="mt-3">
              <a href="/cart" class="btn btn-success w-100">
                <i class="fas fa-shopping-cart me-2"></i> Xem giỏ hàng
              </a>
            </div>
          </div>
        `,

        data() {
            return {
                quantity: 1,
                loading: false,
                message: '',
                messageClass: '',
                productId: null,
                stockQuantity: 0,
                addedToCart: false
            };
        },

        mounted() {
            console.log('Vue AddToCart Component mounted');
            const path = window.location.pathname;
            const match = path.match(/\/products\/(\d+)/);
            if (match) {
                this.productId = match[1];
                console.log('Product ID:', this.productId);
                this.loadProductInfo();
            }
        },

        methods: {
            async loadProductInfo() {
                try {
                    console.log('=== DEBUG: Loading product info ===');
                    console.log('Product ID:', this.productId);

                    const response = await axios.get(`/api/products/${this.productId}`, {
                        withCredentials: true
                    });

                    console.log('Product API response:', response.data);
                    this.stockQuantity = response.data.stockQuantity || 0;

                    if (this.quantity > this.stockQuantity) {
                        this.quantity = Math.max(1, this.stockQuantity);
                    }

                    console.log('Stock quantity:', this.stockQuantity);
                    console.log('=== END DEBUG ===');

                } catch (error) {
                    console.error('Lỗi tải thông tin sản phẩm:', error);
                    console.error('Error details:', error.response);
                    this.showMessage('Lỗi tải thông tin sản phẩm: ' + (error.message || ''), 'danger');
                }
            },

            increment() {
                if (this.quantity < this.stockQuantity) {
                    this.quantity++;
                }
            },

            decrement() {
                if (this.quantity > 1) {
                    this.quantity--;
                }
            },

            async addToCart() {
                console.log('=== DEBUG: ADD TO CART ===');
                console.log('Product ID:', this.productId);
                console.log('Quantity:', this.quantity);
                console.log('Stock:', this.stockQuantity);

                if (this.quantity > this.stockQuantity) {
                    this.showMessage(
                        `<i class="fas fa-exclamation-triangle me-2"></i>Số lượng vượt quá hàng tồn kho (còn ${this.stockQuantity})`,
                        'danger'
                    );
                    return;
                }

                if (this.quantity <= 0) {
                    this.showMessage('Số lượng phải lớn hơn 0', 'danger');
                    return;
                }

                if (this.stockQuantity <= 0) {
                    this.showMessage('Sản phẩm đã hết hàng', 'danger');
                    return;
                }

                this.loading = true;
                this.message = '';
                this.addedToCart = false;

                try {
                    const csrfToken = this.getCsrfToken();
                    console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');

                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    if (csrfToken) {
                        headers['X-CSRF-TOKEN'] = csrfToken;
                    }

                    console.log('Sending add to cart request...');
                    console.log('Endpoint:', `/api/cart/add/${this.productId}?quantity=${this.quantity}`);

                    const response = await axios.post(
                        `/api/cart/add/${this.productId}?quantity=${this.quantity}`,
                        {},
                        {
                            withCredentials: true,
                            headers: headers
                        }
                    );

                    console.log('API Response:', response.data);

                    if (response.data && response.data.success) {
                        this.showMessage(
                            `<i class="fas fa-check-circle me-2"></i>${response.data.message || 'Đã thêm vào giỏ hàng thành công!'}`,
                            'success'
                        );
                        this.addedToCart = true;

                        this.stockQuantity -= this.quantity;
                        this.quantity = 1;

                        this.updateCartCount();

                        setTimeout(() => {
                            this.loadProductInfo();
                        }, 2000);
                    } else if (response.data && response.data.error) {
                        this.showMessage(
                            `<i class="fas fa-exclamation-circle me-2"></i>${response.data.error}`,
                            'danger'
                        );
                    } else {
                        this.showMessage('Lỗi không xác định', 'danger');
                    }

                } catch (error) {
                    console.error('Chi tiết lỗi:', error);
                    console.error('Error response:', error.response);

                    let errorMessage = '<i class="fas fa-exclamation-circle me-2"></i>Lỗi khi thêm vào giỏ hàng';

                    if (error.response?.status === 401) {
                        errorMessage = '<i class="fas fa-lock me-2"></i>Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.';
                        console.error('Session expired');

                        setTimeout(() => {
                            const currentPath = window.location.pathname;
                            window.location.href = '/login?redirect=' + encodeURIComponent(currentPath);
                        }, 2000);

                    } else if (error.response?.status === 404) {
                        errorMessage = '<i class="fas fa-exclamation-triangle me-2"></i>API không tồn tại. Vui lòng kiểm tra controller.';
                        console.error('API Endpoint not found. Please check:');
                        console.error('1. CartApiController has method: @PostMapping("/add/{productId}")');
                        console.error('2. Endpoint should be: /api/cart/add/{productId}');
                        console.error('3. Current URL tried:', error.response?.config?.url);

                        this.testEndpoints();

                    } else if (error.response?.data?.error) {
                        errorMessage = `<i class="fas fa-exclamation-circle me-2"></i>${error.response.data.error}`;
                    } else if (error.response?.status === 403) {
                        errorMessage = '<i class="fas fa-shield-alt me-2"></i>CSRF token không hợp lệ. Vui lòng làm mới trang.';
                        console.error('CSRF token invalid');
                        console.error('CSRF Token used:', csrfToken);
                    } else if (error.message) {
                        errorMessage = `<i class="fas fa-exclamation-circle me-2"></i>${error.message}`;
                    }

                    this.showMessage(errorMessage, 'danger');
                } finally {
                    this.loading = false;
                    console.log('=== END DEBUG ===');
                }
            },

            async testEndpoints() {
                console.log('=== Testing API Endpoints ===');

                try {
                    const productRes = await axios.get(`/api/products/${this.productId}`);
                    console.log('Product API OK:', productRes.status);
                } catch (e) {
                    console.error('Product API failed:', e.message);
                }

                try {
                    const cartRes = await axios.get('/api/cart');
                    console.log('Cart API (GET) OK:', cartRes.status);
                } catch (e) {
                    console.error('Cart API (GET) failed:', e.message);
                }

                try {
                    const testRes = await axios.options('/api/cart/add/1');
                    console.log('CORS Preflight OK:', testRes.status);
                } catch (e) {
                    console.error('CORS Preflight failed:', e.message);
                }
            },

            getCsrfToken() {
                const metaToken = document.querySelector('meta[name="_csrf"]')?.content;
                const inputToken = document.querySelector('input[name="_csrf"]')?.value;
                return metaToken || inputToken;
            },

            async updateCartCount() {
                try {
                    console.log('Updating cart count...');
                    const response = await axios.get('/api/cart', {
                        withCredentials: true
                    });

                    console.log('Cart API response:', response.data);

                    if (response.data && Array.isArray(response.data)) {
                        const count = response.data.reduce((total, item) => total + (item.quantity || 0), 0);
                        console.log('Cart count:', count);

                        const badge = document.querySelector('.cart-badge');
                        if (badge) {
                            badge.textContent = count;
                            badge.style.display = count > 0 ? 'flex' : 'none';
                        }

                        window.dispatchEvent(new CustomEvent('cart-updated', {
                            detail: {count}
                        }));
                    }
                } catch (error) {
                    console.error('Lỗi cập nhật cart count:', error);
                }
            },

            showMessage(text, type) {
                this.message = text;
                this.messageClass = `alert-${type}`;
                setTimeout(() => {
                    this.clearMessage();
                }, 5000);
            },

            clearMessage() {
                this.message = '';
                this.messageClass = '';
            }
        },

        watch: {
            quantity(newVal) {
                if (newVal > this.stockQuantity) {
                    this.quantity = this.stockQuantity;
                }
                if (newVal < 1) {
                    this.quantity = 1;
                }
            }
        }
    };

    console.log('=== Initializing Vue App ===');
    try {
        createApp(AddToCartComponent).mount('#vue-add-to-cart');
        console.log('Vue app mounted successfully');
    } catch (error) {
        console.error('Error mounting Vue app:', error);
    }

    window.addEventListener('cart-updated', function (event) {
        console.log('Cart updated event received:', event.detail.count);
    });
</script>
</body>
</html>